<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PACE Skill Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-slate-100 min-h-screen font-sans">

    <!-- Header -->
    <div class="bg-blue-800 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold"><i class="fa-solid fa-graduation-cap"></i> PACE Connect</h1>
            <span class="text-xs bg-blue-700 px-2 py-1 rounded">Java Backend</span>
        </div>
    </div>

    <div class="max-w-2xl mx-auto p-4">
        
        <!-- Tab Buttons -->
        <div class="flex gap-2 mb-6 bg-white p-1 rounded-lg shadow-sm border">
            <button onclick="showView('search')" id="tab-search" class="flex-1 py-2 rounded text-sm font-bold bg-blue-600 text-white transition">Find Talent</button>
            <button onclick="showView('register')" id="tab-register" class="flex-1 py-2 rounded text-sm font-bold text-gray-500 hover:bg-gray-100 transition">Register</button>
        </div>

        <!-- VIEW 1: SEARCH -->
        <div id="view-search">
            <div class="bg-white p-4 rounded-lg shadow-sm border mb-4">
                <input type="text" id="searchInput" placeholder="Search by Skill (e.g. Java, Python)..." 
                       class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                       onkeyup="searchData()">
            </div>
            <div id="resultsList" class="space-y-3">
                <div class="text-center text-gray-400 py-10">Start typing to search...</div>
            </div>
        </div>

        <!-- VIEW 2: REGISTER -->
        <div id="view-register" class="hidden">
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h2 class="text-lg font-bold mb-4 text-gray-800">New Student Registration</h2>
                
                <div class="space-y-4">
                    <!-- USN Input -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">USN</label>
                        <input type="text" id="in_usn" placeholder="4PA24AI041" class="w-full p-3 border rounded-lg uppercase font-mono bg-gray-50">
                        <p class="text-[10px] text-gray-400 mt-1">Must start with 4PA</p>
                    </div>

                    <!-- Name Input -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Student Name</label>
                        <input type="text" id="in_name" placeholder="Rahul Sharma" class="w-full p-3 border rounded-lg">
                    </div>

                    <!-- Email Input -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">College Email</label>
                        <input type="email" id="in_email" placeholder="4pa...@pace.edu.in" class="w-full p-3 border rounded-lg">
                        <p class="text-[10px] text-gray-400 mt-1">Must end with @pace.edu.in</p>
                    </div>

                    <!-- Skills Input -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Skills</label>
                        <input type="text" id="in_skills" placeholder="Java, Video Editing, React" class="w-full p-3 border rounded-lg">
                        <p class="text-[10px] text-gray-400 mt-1">Separate multiple skills with commas</p>
                    </div>

                    <button onclick="submitData()" id="btnSubmit" class="w-full bg-blue-800 text-white py-3 rounded-lg font-bold hover:bg-blue-900 transition">
                        Register Student
                    </button>
                    
                    <!-- Status Message Area -->
                    <div id="msg" class="text-center text-sm font-bold mt-2 hidden p-2 rounded"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        async function submitData() {
            const btn = document.getElementById('btnSubmit');
            const msg = document.getElementById('msg');
            
            const data = {
                usn: document.getElementById('in_usn').value.toUpperCase().trim(),
                name: document.getElementById('in_name').value.trim(),
                email: document.getElementById('in_email').value.toLowerCase().trim(),
                skills: document.getElementById('in_skills').value.trim()
            };

            // --- CLIENT SIDE VALIDATION ---
            
            // 1. Check USN
            if(!data.usn.startsWith("4PA")) {
                alert("❌ Invalid USN! It must start with '4PA'.");
                return;
            }

            // 2. Check Email Domain
            if(!data.email.endsWith("@pace.edu.in")) {
                alert("❌ Invalid Email! You must use your '@pace.edu.in' college email.");
                return;
            }

            // 3. Check Empty
            if(data.name.length < 2 || data.skills.length < 2) {
                alert("❌ Please fill in all fields correctly.");
                return;
            }

            // --- SEND TO JAVA BACKEND ---
            btn.innerText = "Verifying with Server...";
            btn.disabled = true;
            msg.className = "hidden"; // Hide previous messages

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const resultText = await response.text();
                
                msg.classList.remove("hidden");
                msg.innerText = resultText;

                if(response.ok) {
                    // Success (Green)
                    msg.className = "text-center text-sm font-bold mt-2 bg-green-100 text-green-700 p-2 rounded block";
                    // Clear form
                    document.getElementById('in_usn').value = "";
                    document.getElementById('in_name').value = "";
                    document.getElementById('in_email').value = "";
                    document.getElementById('in_skills').value = "";
                } else {
                    // Error (Red) - Duplicate USN or Email
                    msg.className = "text-center text-sm font-bold mt-2 bg-red-100 text-red-700 p-2 rounded block";
                }
            } catch (error) {
                alert("Error connecting to Java Backend! Is the black terminal window open?");
            }
            btn.innerText = "Register Student";
            btn.disabled = false;
        }

        async function searchData() {
            const query = document.getElementById('searchInput').value;
            const list = document.getElementById('resultsList');
            
            if(query.length < 1) {
                list.innerHTML = "<div class='text-center text-gray-400 py-10'>Start typing to search...</div>";
                return;
            }

            try {
                const response = await fetch('/api/search?q=' + query);
                const students = await response.json();
                
                list.innerHTML = ""; 

                if(students.length === 0) {
                    list.innerHTML = "<div class='text-center text-gray-400'>No matches found via Java</div>";
                    return;
                }

                students.forEach(s => {
                    const card = `
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-l-4 border-l-blue-600 animate-pulse-once">
                            <div class="flex justify-between">
                                <h3 class="font-bold text-gray-800">${s.name}</h3>
                                <span class="text-xs font-mono bg-gray-100 px-2 py-1 rounded border">${s.usn}</span>
                            </div>
                            <a href="mailto:${s.email}" class="text-xs text-blue-600 mt-1 hover:underline block">${s.email}</a>
                            <div class="mt-2 flex flex-wrap gap-1">
                                ${s.skills.split(',').map(sk => `<span class="text-[10px] bg-blue-50 text-blue-800 px-2 py-1 rounded font-bold border border-blue-100">${sk}</span>`).join('')}
                            </div>
                        </div>
                    `;
                    list.innerHTML += card;
                });
            } catch(e) {
                console.error("Search error", e);
            }
        }

        function showView(view) {
            document.getElementById('view-search').classList.add('hidden');
            document.getElementById('view-register').classList.add('hidden');
            document.getElementById('tab-search').className = "flex-1 py-2 rounded text-sm font-bold text-gray-500 hover:bg-gray-100 transition";
            document.getElementById('tab-register').className = "flex-1 py-2 rounded text-sm font-bold text-gray-500 hover:bg-gray-100 transition";
            
            document.getElementById('view-'+view).classList.remove('hidden');
            document.getElementById('tab-'+view).className = "flex-1 py-2 rounded text-sm font-bold bg-blue-600 text-white transition";
            
            // Clear messages when switching tabs
            document.getElementById('msg').classList.add('hidden');
        }
    </script>
</body>
</html>